//@version=5
strategy("BTC SMC Backtest", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.05, slippage=1)

// Inputs
signalTF = input.timeframe("D", "Signal Interval")
onlyOnIntervalClose = input.bool(true, "Trade Only On Interval Close")
swingLen = input.int(3, "Swing Length", minval=1)
requireCloseBreak = input.bool(true, "BOS Requires Close Beyond Swing")
sweepAtrMult = input.float(0.0, "Sweep Buffer (ATR Mult)", minval=0.0, step=0.05)
riskReward = input.float(2.0, "Risk/Reward", minval=0.5, step=0.1)
atrLen = input.int(14, "ATR Length", minval=1)
atrMult = input.float(1.5, "ATR Stop Multiplier", minval=0.1, step=0.1)
startDate = input.time(timestamp("2019-01-01"), "Start Date")
endDate = input.time(timestamp("2030-01-01"), "End Date")

// Date filter
timeTF = request.security(syminfo.tickerid, signalTF, time, barmerge.gaps_off, barmerge.lookahead_off)
inDateRange = (timeTF >= startDate) and (timeTF <= endDate)
intervalBarClosed = ta.change(timeTF)
signalBar = not onlyOnIntervalClose or intervalBarClosed

// HTF data
highTF = request.security(syminfo.tickerid, signalTF, high, barmerge.gaps_off, barmerge.lookahead_off)
lowTF = request.security(syminfo.tickerid, signalTF, low, barmerge.gaps_off, barmerge.lookahead_off)
closeTF = request.security(syminfo.tickerid, signalTF, close, barmerge.gaps_off, barmerge.lookahead_off)
atrTF = request.security(syminfo.tickerid, signalTF, ta.atr(atrLen), barmerge.gaps_off, barmerge.lookahead_off)

// Structure
pivotHigh = request.security(syminfo.tickerid, signalTF, ta.pivothigh(high, swingLen, swingLen), barmerge.gaps_off, barmerge.lookahead_off)
pivotLow = request.security(syminfo.tickerid, signalTF, ta.pivotlow(low, swingLen, swingLen), barmerge.gaps_off, barmerge.lookahead_off)

var float lastSwingHigh = na
var float lastSwingLow = na

if not na(pivotHigh)
    lastSwingHigh := pivotHigh
if not na(pivotLow)
    lastSwingLow := pivotLow

sweepBuffer = atrTF * sweepAtrMult

sweepBelow = not na(lastSwingLow) and (lowTF < lastSwingLow - sweepBuffer) and (closeTF > lastSwingLow)
sweepAbove = not na(lastSwingHigh) and (highTF > lastSwingHigh + sweepBuffer) and (closeTF < lastSwingHigh)

bosUp = not na(lastSwingHigh) and (requireCloseBreak ? closeTF > lastSwingHigh : highTF > lastSwingHigh)
bosDown = not na(lastSwingLow) and (requireCloseBreak ? closeTF < lastSwingLow : lowTF < lastSwingLow)

var bool sweptBelow = false
var bool sweptAbove = false

if signalBar
    if sweepBelow
        sweptBelow := true
    if sweepAbove
        sweptAbove := true

longSignal = signalBar and sweptBelow and bosUp
shortSignal = signalBar and sweptAbove and bosDown

if longSignal
    sweptBelow := false
if shortSignal
    sweptAbove := false

// Risk management
longStop = close - atrMult * atrTF
shortStop = close + atrMult * atrTF
longLimit = close + (atrMult * atrTF) * riskReward
shortLimit = close - (atrMult * atrTF) * riskReward

canTrade = inDateRange and signalBar

if canTrade and longSignal
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", from_entry="Long", stop=longStop, limit=longLimit)

if canTrade and shortSignal
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", from_entry="Short", stop=shortStop, limit=shortLimit)

plot(lastSwingHigh, color=color.new(color.orange, 0), title="Swing High", style=plot.style_linebr)
plot(lastSwingLow, color=color.new(color.teal, 0), title="Swing Low", style=plot.style_linebr)
plotshape(longSignal, title="Long Signal", style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.tiny)
plotshape(shortSignal, title="Short Signal", style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.tiny)
